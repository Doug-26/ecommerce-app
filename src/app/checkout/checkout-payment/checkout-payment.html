<div class="payment-step">
  <h4 class="mb-4">Payment Method</h4>

  @if (!showForm()) {
    @if (justSavedPayment()) {
      <!-- Success message after saving payment method -->
      <div class="alert alert-success mb-4">
        <div class="d-flex align-items-center">
          <i class="fas fa-check-circle me-2"></i>
          <div class="flex-grow-1">
            <strong>Payment method saved successfully!</strong>
            <p class="mb-0 mt-1">Your payment method has been saved and selected.</p>
          </div>
        </div>
      </div>
      
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" (click)="back.emit()">
          <i class="fas fa-arrow-left me-2"></i>Back to Shipping
        </button>
        <button class="btn btn-success" (click)="continue.emit()">
          <i class="fas fa-arrow-right me-2"></i>Continue to Review
        </button>
      </div>
    } @else {
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Saved Payment Methods</h6>
        <button class="btn btn-sm btn-outline-primary" (click)="startAdd()">Add New</button>
      </div>

      @if (methods().length) {
        <div class="list-group mb-3">
          @for (m of methods(); track m.id) {
            <div class="list-group-item d-flex align-items-start"
                 [class.active]="selectedPaymentId() === m.id">
              <div class="form-check me-3 mt-1">
                <input class="form-check-input" type="radio" name="pmSelect"
                       [value]="m.id"
                       [checked]="selectedPaymentId() === m.id"
                       (change)="selectPayment(m.id!)">
              </div>
              <div class="flex-grow-1">
                <strong>{{ labelForMethod(m) }}</strong><br>
                @if (m.type === 'credit_card' || m.type === 'debit_card') {
                  <small>{{ m.brand || 'Card' }} •••• {{ m.last4 }}</small>
                }
                @if (m.type === 'paypal') {
                  <small>{{ m.email }}</small>
                }
              </div>
              <div class="ms-3 d-flex flex-column gap-2">
                <button class="btn btn-sm btn-outline-secondary" (click)="startEdit(m)">Edit</button>
                <button class="btn btn-sm btn-outline-danger" (click)="removePayment(m)">Delete</button>
              </div>
            </div>
          }
        </div>
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" (click)="back.emit()">Back</button>
          <button class="btn btn-primary" [disabled]="!selectedPaymentId()" (click)="useSelectedPayment()">
            Continue to Review
          </button>
        </div>
      } @else {
        <div class="alert alert-info">
          No saved payment methods yet. Click "Add New" to create one.
        </div>
        <button type="button" class="btn btn-outline-secondary me-2" (click)="back.emit()">Back</button>
        <button class="btn btn-primary" (click)="startAdd()">Add Payment Method</button>
      }
    }
  } @else {
    <form [formGroup]="form" (ngSubmit)="submitForm()" novalidate>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">{{ editingPaymentId() ? 'Edit Payment Method' : 'Add Payment Method' }}</h6>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="cancelForm()">
          <i class="fas fa-arrow-left me-1"></i>Back
        </button>
      </div>

      <div class="mb-3">
        <label class="form-label">Type *</label>
        <select class="form-select" formControlName="type" (change)="onTypeChange()">
          <option value="credit_card">Credit Card</option>
          <option value="debit_card">Debit Card</option>
          <option value="paypal">PayPal</option>
        </select>
      </div>

      @if (isCard()) {
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Cardholder Name *</label>
            <input class="form-control" formControlName="cardholderName" [class.is-invalid]="invalid('cardholderName')">
            @if (invalid('cardholderName')) { <div class="invalid-feedback">Required</div> }
          </div>
          <div class="col-md-6">
            <label class="form-label">Card Number *</label>
            <input class="form-control" formControlName="cardNumber" maxlength="19" [class.is-invalid]="invalid('cardNumber')">
            @if (invalid('cardNumber')) { <div class="invalid-feedback">Required</div> }
          </div>
          <div class="col-md-3">
            <label class="form-label">Expiry Month *</label>
            <input class="form-control" formControlName="expiryMonth" type="number" min="1" max="12" [class.is-invalid]="invalid('expiryMonth')">
            @if (invalid('expiryMonth')) { <div class="invalid-feedback">Required</div> }
          </div>
            <div class="col-md-3">
            <label class="form-label">Expiry Year *</label>
            <input class="form-control" formControlName="expiryYear" type="number" min="2024" max="2050" [class.is-invalid]="invalid('expiryYear')">
            @if (invalid('expiryYear')) { <div class="invalid-feedback">Required</div> }
          </div>
          <div class="col-md-3">
            <label class="form-label">Brand</label>
            <input class="form-control" formControlName="brand" placeholder="Visa / MasterCard">
          </div>
          <div class="col-md-3">
            <label class="form-label">Last 4 *</label>
            <input class="form-control" formControlName="last4" maxlength="4" [class.is-invalid]="invalid('last4')">
            @if (invalid('last4')) { <div class="invalid-feedback">Required</div> }
          </div>
        </div>
      } @else {
        <div class="mb-3">
          <label class="form-label">PayPal Email *</label>
          <input class="form-control" formControlName="email" type="email" [class.is-invalid]="invalid('email')">
          @if (invalid('email')) { <div class="invalid-feedback">Valid email required</div> }
        </div>
      }

      <div class="d-flex justify-content-end mt-4">
        <button type="submit" class="btn btn-success">
          {{ editingPaymentId() ? 'Save Changes' : 'Save Payment Method' }}
        </button>
      </div>
    </form>
  }
</div>
